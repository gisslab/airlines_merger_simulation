
. 
. use "$PROC_DATA/airline_data_main.dta", clear

. 
. // global mainpath "/Users/karamkang/Library/CloudStorage/Dropbox/Teaching/MS-IO/final_project"
. // log using "$mainpath/analysis/prelim_analysis.log", replace
. 
. // use "$mainpath/data/airline_data_main.dta", clear
. *---------------------------
. * 1. preparing the data
. *---------------------------
. 
. // * Checking that legacy and lcc carriers have no overlap
. // preserve
. // bys carrier: keep if _n==1
. // list carrier legacy lcc if !missing(legacy) | !missing(lcc)
. // restore
. 
. * focus on a 5% sub-sample of the data (for computational purposes)
. //! this way of randomizing is creating bias towards smaller markets (less observations per market)
. // set seed 12345
. // gen random_uniform = runiform()
. // bys market_code: egen rr = mean(random_uniform)
. // quietly sum rr, detail
. // keep if rr<r(p5)
. 
. // * new addition: sample 15% of markets, sample one market at a time
. preserve

. set seed 12345

. bys market_code: keep if _n == 1  // Keep one obs per market
(1,669,808 observations deleted)

. sample 25                          // Sample 15% of markets
(6,044 observations deleted)

. keep market_code                  // Keep only market identifier

. tempfile sampled_markets

. save `sampled_markets'
file /var/folders/xb/mch0wfzd205d97392nxjwj240000gn/T//S_80950.000002 saved as .dta format

. restore

. merge m:1 market_code using `sampled_markets', keep(match) nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           411,747  
    -----------------------------------------

. 
. * define markets: time-destination-origin
. encode carrier, gen(firmid)

. egen marketid = group(year quarter market_code)

. egen marketid2 = group(market_code)

. 
. * market size: alternatives
. gen pop_o_d_geo_mean = sqrt(origin_pop * dest_pop)      // geometric mean 
(8,493 missing values generated)

. gen pop_sum = origin_pop + dest_pop                     // sum
(8,493 missing values generated)

. gen mean_pop = (origin_pop + dest_pop)/2        // average
(8,493 missing values generated)

. gen max_pop = max(origin_pop, dest_pop)         // maximum
(2 missing values generated)

. 
. * declare market size
. gen msize = pop_o_d_geo_mean/20 //  * new addition : scaling down market size to avoid numerical issues
(8,493 missing values generated)

. gen mshare = total_passengers/msize
(8,493 missing values generated)

. egen mshare_inside = sum(mshare), by(marketid)

. sum mshare mshare_inside

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
      mshare |    403,254    .0028042    .0143071   1.44e-06   .9298084
mshare_ins~e |    411,747    .0165799     .038175          0   1.305036

. 
. 
. // * new addition: Filter out extremely small market shares that cause numerical issues
. scalar min_share_threshold = 10^-5  // 0.01% minimum share

. keep if mshare >= min_share_threshold
(9,053 observations deleted)

. keep if mshare_inside <= 0.995  // Also filter implausibly large shares
(122 observations deleted)

. 
. // * new addition: eliminate singleton markets after share filtering
. bys marketid: keep if _N > 1
(69 observations deleted)

. 
. * nesting groups: alternatives
. gen inside = 1

. gen nonstop_route = (share_nonstop > 0)  // by non stop vs. connecting

. 
. * declare nesting groups
. gen nest1 = inside // ! comment

. gen nest2 = 3 // ! comment

. replace nest2 = 1 if legacy == 1 // ! comment
(300,699 real changes made)

. replace nest2 = 2 if lcc == 1
(79,773 real changes made)

. 
. * market/product attributes
. gen dist_k   = average_distance/1000    // distances in thousands

. gen dist_k2  = dist_k^2                                 // distances in thousands, squared

. gen lnum_fringe = ln(1 + fringe_carriers)

. 
. * declare market/product attributes to control for
. local x_exog "share_nonstop dist_k dist_k2 lnum_fringe"

. 
. * instruments for market share
. bys marketid nest1 nest2: egen rival_carriers_nest = sum(inside)

. replace rival_carriers_nest = rival_carriers_nest-1 // number of rivals within the nest
(402,503 real changes made)

. 
. // * new addition: create additional IV for upper level nesting (rival carriers in market)
. * declare instruments for price and market share
. local inst "average_distance_rival average_num_destinations_rival rival_carriers_nest rival_carriers" // rival_carriers

. 
. * set the panel data: product x markets
. xtset firmid marketid

Panel variable: firmid (unbalanced)
 Time variable: marketid, 1 to 75961, but with gaps
         Delta: 1 unit

. 
. *-------------------------------------
. * 2. performing a merger simulation
. *-------------------------------------
. 
. * step 1: initializing the merger simulation settings
. mergersim init, nests(nest1 nest2) price(average_fare) quantity(total_passengers) marketsize(msize) firm(firmid)
--------------------------------------------------------------------------------
MERGERSIM: Merger Simulation Program
Version 1.0, Revision: 218 
--------------------------------------------------------------------------------
Unit demand two-level nested logit

                  Depvar              Price               Group shares
                  --------------------------------------------------------------
                  M_ls                average_fare        M_lsjh M_lshg
--------------------------------------------------------------------------------
Variables generated: M_ls M_lsjh M_lshg
--------------------------------------------------------------------------------

. // mergersim init, nests(nest2) price(average_fare) quantity(total_passengers) marketsize(msize) firm(firmid)
. 
. // sum M_ls M_lsjh M_lshg // exploring that log nests are the same than in the demand estimation.do -----> YES
. 
. * step 2: nested logit demand model estimation
. ivreghdfe M_ls (average_fare M_lshg M_lsjh = `inst') `x_exog', absorb(marketid2) cluster(marketid2)
(MWFE estimator converged in 1 iterations)

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity and clustering on marketid2

Number of clusters (marketid2) =   1967               Number of obs =   394010
                                                      F(  7,  1966) = 59387.68
                                                      Prob > F      =   0.0000
Total (centered) SS     =  1044441.162                Centered R2   =   0.9636
Total (uncentered) SS   =  1044441.162                Uncentered R2 =   0.9636
Residual SS             =  38013.97484                Root MSE      =    .3106

-------------------------------------------------------------------------------
              |               Robust
         M_ls | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
 average_fare |  -.0034503   .0008706    -3.96   0.000    -.0051578   -.0017428
       M_lshg |    .938648   .0377333    24.88   0.000     .8646465    1.012649
       M_lsjh |   .8926962   .0197215    45.27   0.000      .854019    .9313734
share_nonstop |   .2452516   .0553674     4.43   0.000     .1366666    .3538366
       dist_k |  -.2251934   .1175689    -1.92   0.056    -.4557662    .0053794
      dist_k2 |   .0236389   .0062069     3.81   0.000     .0114661    .0358117
  lnum_fringe |  -.0157074   .0085644    -1.83   0.067    -.0325036    .0010888
-------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):             61.871
                                                   Chi-sq(2) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):              148.592
                         (Kleibergen-Paap rk Wald F statistic):         17.499
Stock-Yogo weak ID test critical values:                       <not available>
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):        11.772
                                                   Chi-sq(1) P-val =    0.0006
------------------------------------------------------------------------------
Instrumented:         average_fare M_lshg M_lsjh
Included instruments: share_nonstop dist_k dist_k2 lnum_fringe
Excluded instruments: average_distance_rival average_num_destinations_rival
                      rival_carriers_nest rival_carriers
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
   marketid2 |      1967        1967           0    *|
-----------------------------------------------------+
* = FE nested within cluster; treated as redundant for DoF computation

. // ivreghdfe M_ls (average_fare M_lsjg = `inst') `x_exog', absorb(marketid2) cluster(marketid2)
. 
. * step 3: analyzing premerger market conditions
. mergersim market if year == 2013
---------------------------------------------------------------------------------
Supply: Bertrand competition
Demand: Unit demand two-level nested logit
--------------------------------------------------------------------------------
Demand estimate
ivreghdfe M_ls (average_fare M_lshg M_lsjh = average_distance_rival average_num_destinations_rival rival_carriers_nest rival_carri
> ers) share_nonstop dist_k dist_k2 lnum_fringe, absorb(marketid2) cluster(marketid2)
Dependent variable: M_ls
--------------------------------------------------------------------------------

Parameters

alpha = -0.003
sigma1 = 0.893 
sigma2 = 0.939 
----------------------------------------------------------------
Own- and Cross-Price Elasticities:  unweighted market averages

    Variable |      Mean        SD       Min       Max
-------------+----------------------------------------
       M_ejj |    -7.241     3.056   -53.366    -0.186
       M_ejk |     0.314     2.207   -13.528    13.439
       M_ejl |     2.415     2.796     0.000    24.706
       M_ejm |     0.002     0.006     0.000     0.242
------------------------------------------------------
Observations: 24578
----------------------------------------------------------------
ERROR: sigma 2 should be smaller than sigma 1.
sigma1: .8926961725072823
sigma2: .9386480181992081

Pre-merger Market Conditions 
Unweighted averages by firmid

---------------------------------------------------------------------------------
              firmid |       average_fare      Marginal costs   Pre-merger Lerner
---------------------+-----------------------------------------------------------
                  7H |            156.498             138.643               0.115
                  AA |            245.965             206.942               0.171
                  AB |             79.467                                        
                  AS |            291.334             245.089               0.216
                  B6 |            221.995             191.742               0.152
                  BA |            168.241             149.456               0.162
                  DL |            245.805             202.050               0.189
                  F9 |            180.955             152.105               0.177
                  FL |            186.704             165.213               0.121
                  G4 |             94.390              19.225               0.875
                  HA |            342.479             261.882               0.557
                  IB |             47.125                                        
                  LW |            100.257              82.453               0.178
                  NK |            123.947              80.283               0.341
                  SY |            200.552             160.461               0.197
                  UA |            247.507             209.974               0.160
                  US |            259.018             220.005               0.162
                  VX |            226.123             206.989               0.096
                  WN |            203.174             170.135               0.181
                  WP |            115.305              97.519               0.157
                  WS |            117.352                                        
                  YV |             84.864              65.517               0.248
---------------------------------------------------------------------------------
Variables generated: M_costs M_delta 
---------------------------------------------------------------------------------

. 
. * step 4: simulating the merger effects
. *         consider a merger between AA (buyer) and US (seller)
. *         note: AA and US merger approved in Dec 2013
. mergersim simulate if year == 2014, seller(61) buyer(6) detail
Simulation did not converge.
Error: 

---------------------------------------------------------------------------------
Merger Simulation

                                            Simulation method: Newton
                        Buyer     Seller    Periods/markets: 4917
Firm                    6         61        Average number of iterations: 25.34 
                                            Max number of iterations: 1000  
Marginal cost savings                       Max price change in last it: .000014  
---------------------------------------------------------------------------------

Prices
Unweighted averages by firmid

---------------------------------------------------------------------------------
              firmid |         Pre-merger         Post-merger     Relative change
---------------------+-----------------------------------------------------------
                  3M |             85.642              85.642              -0.000
                  7H |            148.416             148.416               0.000
                  AA |            253.769             253.769               0.000
                  AS |            290.125             290.125              -0.000
                  B6 |            216.785             216.785               0.000
                  BA |            244.949             244.949               0.000
                  DL |            252.910             252.910              -0.000
                  EV |            170.501             170.501               0.000
                  F9 |            178.715             178.715              -0.000
                  FL |            186.833             186.833              -0.000
                  G4 |             92.546              92.546              -0.000
                  HA |            374.465             374.465               0.000
                  NK |            123.708             123.708               0.000
                  QR |            208.959             208.959               0.000
                  SY |            196.818             196.818               0.000
                  UA |            254.345             254.345              -0.000
                  US |            251.450             251.450               0.000
                  VX |            207.281             207.281               0.000
                  WN |            204.048             204.048              -0.000
                  WP |             92.182              92.182              -0.000
                  YV |             63.382              63.382               0.000
---------------------------------------------------------------------------------
Variables generated: M_price2 M_quantity2 M_price_ch (Other M_ variables dropped)
---------------------------------------------------------------------------------

Market shares by quantity
Unweighted averages by firmid

---------------------------------------------------------------------------------
              firmid |         Pre-merger         Post-merger          Difference
---------------------+-----------------------------------------------------------
                  3M |              0.010               0.010              -0.000
                  7H |              0.005               0.005               0.000
                  AA |              0.144               0.144               0.000
                  AS |              0.190               0.190              -0.000
                  B6 |              0.109               0.109               0.000
                  BA |              0.003               0.003               0.000
                  DL |              0.253               0.253              -0.000
                  EV |              0.002               0.002               0.000
                  F9 |              0.110               0.110              -0.000
                  FL |              0.025               0.025               0.000
                  G4 |              0.643               0.643              -0.000
                  HA |              0.344               0.344               0.000
                  NK |              0.116               0.116               0.000
                  QR |              0.003               0.003              -0.000
                  SY |              0.123               0.123               0.000
                  UA |              0.163               0.163              -0.000
                  US |              0.166               0.166               0.000
                  VX |              0.045               0.045               0.000
                  WN |              0.312               0.312              -0.000
                  WP |              0.000               0.000              -0.000
                  YV |              0.021               0.021               0.000
---------------------------------------------------------------------------------

--------------------------------------------------
                        Pre-merger     Post-merger
--------------------------------------------------
HHS:                     4272           4272
C4:                     94.54          94.54
C8:                     97.65          97.65
--------------------------------------------------
----------------------------------------
                                 Change
----------------------------------------
Consumer surplus:                    -0
Producer surplus:                    -0
----------------------------------------

. 
. log close
      name:  <unnamed>
       log:  /Users/gisellelab/Work/airlines_merger_simulation/src//logs/prelim_analysis_merger.log
  log type:  text
 closed on:  17 Sep 2025, 23:27:49
----------------------------------------------------------------------------------------------------------------------------------
