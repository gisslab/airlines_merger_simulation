--------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/gisellelab/Work/airlines_merger_simulation/src/logs/demand_estimation.log
  log type:  text
 opened on:  19 Aug 2025, 19:06:08

. 
. // ---------------------- PARAMETERS -------------------------------------------
. global YEARS   "2005/2019"

. global QUARTERS "1 2 3 4"

. global TYPE     "Market"   // DB1B “Market”

. 
. di as yellow "--------------------------------------------------------------------------------------------------"
--------------------------------------------------------------------------------------------------

. di as yellow "----------------------------------- Running demand_estimation.do --------------------------------"
----------------------------------- Running demand_estimation.do --------------------------------

. di as yellow "--------------------------------------------------------------------------------------------------"
--------------------------------------------------------------------------------------------------

. 
. cap mkdir "$OUT"

. 
. di as yellow "    Demand estimation started for years: $YEARS, quarters: $QUARTERS, type: $TYPE"
    Demand estimation started for years: 2005/2019, quarters: 1 2 3 4, type: Market

. 
. * Source data from previous step
. local source_csv "${PROC_DATA}airline_data.csv"

. di as yellow "    Source data: `source_csv'"
    Source data: ./data/processed/combined/airline_data.csv

. 
. * Column mapping in your airline_data.csv (matching processing_data.do output)
. * Required identifiers
. local id_prod      "product_id"            // product (itinerary/airline) id - we'll create this

. local id_market    "market"                // origin–destination market id (fixed effect)

. local id_time      "time"                  // time (optional control/cluster)

. local id_carrier   "carrier"               // marketing carrier code 

. local id_group     "carrier_dummy"          // definition for nesting e.g. major, carrier_dummy(inside vs outside)

. 
. * Demand-side quantities (matching processing_data.do variable names)
. local var_fare     "average_fare"          // average ticket price

. local var_nest     "lns_minus_lng"          // ln(s_jt|g) for nested logit, lng_share or lns_minus_lng

. local var_fringe   "fringe_carriers"        // fringe_carriers: number of rival carriers in market // this might suppose
> d to be something else

. 
. * Rival-based instruments (matching processing_data.do variable names)
. local iv_rivaldist   "average_distance_rival" // average distance rival (for IV)

. local iv_rivalpres   "average_presence_rival" // average presence rival (for IV)

. local iv_rivalmkts   "average_num_destinations_rival" // options: average_num_destinations_rival average_num_markets_riv
> al

. local iv_numrivals   "rival_carriers"

. 
. *-------------------------*
. * LOCALS FOR ESTIMATION  *
. *-------------------------*
. 
. di as yellow "    ---------  Setting up locals for estimation ---------"
    ---------  Setting up locals for estimation ---------

. 
. * Core X’s (match Table C2): price first so α is easy to spot, Other var: logS?
. local X_exog  "share_nonstop dist_k dist_k2 lnum_fringe"

. local X_core  "`var_fare' `X_exog'"

. 
. * Instruments (rival shifters)
. local Z_core  "`iv_rivaldist' `iv_rivalmkts' `iv_numrivals'"

. 
. * FE and clusters
. local FE      "`id_market'"              // OD fixed effects, plus time maybe `id_time'

. local CL      "`id_market'"       // cluster by OD (you can switch) O-D clusters with those FE cause collinearity when I
> Vs.

. 
. *-------------------------*
. * LOAD & PREP            *
. *-------------------------*
. import delimited using "`source_csv'",  clear
(encoding automatically selected: ISO-8859-1)
(35 vars, 1,677,867 obs)

. 
. * Make sure key variables are in proper format
. * market and time are strings, carrier is string - this is fine for now
. * but we need to handle them as strings
. 
. * Create product ID (combination of market, carrier, time)
. egen long product_id = group(`id_market' `id_carrier' `id_time')
(29 missing values generated)

. 
. * Make sure time can be used for grouping (keep as string for now)
. * market stays as string (it's the market identifier)
. * carrier stays as string
. 
. * Create proper market shares first (as in processing_data.do commented code)
. di as yellow "    ---------  Creating shares and log differences ---------"
    ---------  Creating shares and log differences ---------

. 
. //********** move from here 
. // TODO:  Move avd dist  to processing_data.do
. // Calculate rival average distance (for future IV use)
. // bysort origin destination year quarter: egen double total_distance = total(average_distance)
. // bysort origin destination year quarter: gen double average_distance_rival = ///
. //     (total_distance - average_distance) / ( _N - 1 )
. // drop total_distance
. 
. // // TODO:  Move fringe  to processing_data.do
. // // Calculate number of fringe firms (non-major carriers) per market
. // // Assuming major_carrier_flag is created in carrier_flags.do
. // gen fringe = 1 - major
. // bysort origin destination year quarter: egen fringe_carriers = total(fringe)
. //********** move until here
. 
. * Market-level total passengers (sum over products in each market-time)
. bys `id_market' `id_time': egen pax_market = total(total_passengers)

. 
. // * Market shares for logit
. gen s_jt = (10 * total_passengers)/market_size // mkt size is sqrt(orig_pop*dest_pop), so share is scaled by 10
(40,951 missing values generated)

. bys `id_market' `id_time': egen s_inside_t = total(s_jt)

. gen s_0t = 1 - s_inside_t

. replace s_0t = .0000001 if s_0t<=0  // small epsilon to avoid -inf
(0 real changes made)

. 
. * log(S_t): create from market_size (which is sqrt(orig_pop*dest_pop))
. gen logS = ln(market_size)
(40,951 missing values generated)

. 
. * Dependent variable for simple logit
. gen lns_minus_lno = ln(s_jt) - ln(s_0t)
(40,951 missing values generated)

. 
. // * Nest definition: Group by  nest
. 
. // * Possible nests definitions:
. 
. // - inside goods
. gen carrier_dummy = 1

. 
. // - by airline type (major vs. non-major):
. // egen nest_g = group(`id_market' `id_time' major)
. 
. // - by non stop vs. connecting :
. gen nonstop_route = (share_nonstop >= 0.5)  // or some threshold// egen nest_g = group(`id_market' `id_time' nonstop_rou
> te)

. 
. // - by carrier type (legacy vs. LCC)
. // egen nest_g = group(`id_market' `id_time' legacy)  // or major, or lcc
. 
. // - by hub vs. non-hub:
. gen hub_route = (origin_hub == 1 | destination_hub == 1) // egen nest_g = group(`id_market' `id_time' hub_route)

. 
. // * Create definition var with defined `var_group'
. * This creates meaningful nests where multiple carriers belong to the same nest
. egen nest_g = group(`id_market' `id_time' `id_group')  // or legacy, or lcc

. bys nest_g: egen s_gjt = total(s_jt)                   // nest share (incl current j)

. 
. // replace s_gjt = min(max(s_gjt, .000001), .999999)
. 
. * Nested-logit transformed outcome
. gen lns_minus_lng = ln(s_jt) - ln(s_gjt)
(40,951 missing values generated)

. 
. gen lng_share = ln(s_gjt) // this should be the within cluster share  s_jt // is this necessary?
(40,951 missing values generated)

. 
. // let's eliminate singleton mkts to avoid collinearity and issues when ivreghdfe
. bys `id_market' `id_time': keep if _N > 1
(0 observations deleted)

. 
. // -------------------------*
.  * Other variables X
. *-------------------------*
. 
. * Distances in thousands and squared
. gen dist_k   = average_distance/1000

. gen dist_k2  = dist_k^2

. 
. * Log(1 + fringe carriers)
. gen lnum_fringe = ln(1 + `var_fringe')

. 
. // -------------------------*
. * Check variables
. *-------------------------*
. * Keep a clean estimation sample
. di as yellow "    Initial observations: " _N
    Initial observations: 1677867

. keep if s_jt>0 & s_0t>0 & s_gjt>0
(40,951 observations deleted)

. di as yellow "    After share filters: " _N
    After share filters: 1636916

. foreach v of varlist `X_core' {
  2.     drop if missing(`v')
  3. }
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)

. di as yellow "    After X_core missing: " _N
    After X_core missing: 1636916

. drop if missing(lns_minus_lno) | missing(lns_minus_lng)
(0 observations deleted)

. di as yellow "    After outcome missing: " _N
    After outcome missing: 1636916

. 
. * Check instrument availability
. foreach v of varlist `Z_core' {
  2.     drop if missing(`v')
  3. }
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)

. di as yellow "    After instrument missing: " _N
    After instrument missing: 1636916

. 
. * Final sample check
. di as yellow "    Final estimation sample: " _N
    Final estimation sample: 1636916

. if _N < 50 {
.     di as red "WARNING: Very small sample size for estimation!"
.     di as red "Consider relaxing sample restrictions"
. }

. 
. * -------------------------*
. * Labels
. *-------------------------*
. 
. do "$CODE_DIR/labels.do"

. // -----------------------------------------------------------------------------
. // * File:    labels.do
. // * Purpose: Labels for variables in the dataset
. // -----------------------------------------------------------------------------
. 
. label var lns_minus_lno "ln(s_jt) - ln(s_0t)"

. label var lns_minus_lng "ln(s_jt) - ln(s_gt)"

. label var average_fare "Average fare (dollars)"

. label var logS "Log of market size"

. label var share_nonstop "Share nonstop flights "

. label var dist_k "Average Distance (000s miles)"

. label var dist_k2 "Average Distance sqr (000s miles)"

. label var lnum_fringe "Log(1 + fringe carriers)"

. label var fringe_carriers "Number of fringe carriers"

. label var num_markets "Number of destinations served"

. label var rival_carriers "Number of rival carriers"

. label var lng_share "Log nest share"

. label var s_jt "Market share"

. label var s_0t "Outside share"

. label var s_inside_t "Inside share sum"

. label var s_gjt "Nest share"

. label var lng_share "ln(s_gt)"

. label var average_num_markets_rival "Average number of rival markets"

. label var average_num_destinations_rival "Average number of rival destinations"

. label var average_distance_rival "Average distance to rival markets"

. label var average_presence_rival "Average presence of rival carriers"

. // label var elast_logit "Own elasticity (logit)"
. // label var elast_nlogit "Own elasticity (nested-logit)"
. // -----------------------------------------------------------------------------
. 
end of do-file

. 
. *-------------------------*
. * SUMMARY STATS → LaTeX  *
. *-------------------------*
. cap which esttab

. if _rc ssc install estout, replace

. 
. sum lns_minus_lno lns_minus_lng lng_share `X_core' share s_jt s_0t s_inside_t

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
lns_minus_~o |  1,636,916    -8.05655    1.858922  -14.27474   .0842574
lns_minus_~g |  1,636,916   -2.735036    1.854939  -11.71411   -.000062
   lng_share |  1,636,916   -5.329907    .9424638   -8.70559  -.4101813
average_fare |  1,636,916    224.8843    92.99161         25   2492.016
share_nons~p |  1,636,916    .2020219    .3616515          0          1
-------------+---------------------------------------------------------
      dist_k |  1,636,916    1.493539    .8604235       .067     10.345
     dist_k2 |  1,636,916    2.970988    3.732698    .004489    107.019
 lnum_fringe |  1,636,916    .3498799    .4551073          0   2.564949
share_nons~p |  1,636,916    .2020219    .3616515          0          1
        s_jt |  1,636,916    .0013417    .0058076   6.12e-07   .4734702
-------------+---------------------------------------------------------
        s_0t |  1,636,916    .9918026    .0157906   .3364701   .9998344
  s_inside_t |  1,636,916    .0081974    .0157906   .0001657   .6635299

. sum `Z_core' `var_fare' dist_k dist_k2 lnum_fringe

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
average_di~l |  1,636,916    1493.539     830.698         67    5996.58
ave~ns_rival |  1,636,916    52.18329     26.1421          1        153
rival_carr~s |  1,636,916    5.234965    2.249802          1         22
average_fare |  1,636,916    224.8843    92.99161         25   2492.016
      dist_k |  1,636,916    1.493539    .8604235       .067     10.345
-------------+---------------------------------------------------------
     dist_k2 |  1,636,916    2.970988    3.732698    .004489    107.019
 lnum_fringe |  1,636,916    .3498799    .4551073          0   2.564949

. 
. qui estpost sum s_jt s_0t s_inside_t s_gjt rival_carriers num_markets `X_core', detail

. esttab using "$OUT/demand_vars_stats.tex", replace ///
>     title("Summary statistics: variables used in demand estimation") ///
>     cells("mean(fmt(3)) sd(fmt(3)) min(fmt(4)) p25(fmt(4)) p50(fmt(3)) p75(fmt(3)) max(fmt(3))") ///
>     label booktabs nonum
(output written to ./src/output//demand_vars_stats.tex)

. 
. display as text "Saved: $OUT/demand_vars_stats.tex"
Saved: ./src/output//demand_vars_stats.tex

. 
. *-------------------------*
. * OLS (logit form)       *
. *-------------------------*
. di as yellow "    ---------  Running OLS logit (informal) ---------"
    ---------  Running OLS logit (informal) ---------

. 
. cap which reghdfe

. if _rc ssc install reghdfe, replace

. reghdfe lns_minus_lno `X_core', absorb(`FE') vce(robust) // vce(cluster `CL')
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =  1,636,916
Absorbing 1 HDFE group                            F(   5,1629068) =  264881.65
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.5054
                                                  Adj R-squared   =     0.5030
                                                  Within R-sq.    =     0.4475
                                                  Root MSE        =     1.3105

-------------------------------------------------------------------------------
              |               Robust
lns_minus_lno | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
 average_fare |  -.0017187   .0000256   -67.13   0.000    -.0017688   -.0016685
share_nonstop |   1.950423   .0046504   419.41   0.000     1.941308    1.959538
       dist_k |  -4.143684    .013915  -297.78   0.000    -4.170957   -4.116411
      dist_k2 |   .2762392   .0033415    82.67   0.000       .26969    .2827884
  lnum_fringe |  -.5032103   .0033035  -152.33   0.000    -.5096851   -.4967356
        _cons |  -2.519965   .0130457  -193.16   0.000    -2.545534   -2.494396
-------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
      market |      7843           0        7843     |
-----------------------------------------------------+

. estimates store OLS

. 
. *-------------------------*
. * IV-LOGIT (price endog) *
. *-------------------------*
. di as yellow "    ---------  Running IV logit (price endogenous) ---------"
    ---------  Running IV logit (price endogenous) ---------

. 
. cap which ivreghdfe

. if _rc ssc install ivreghdfe, replace

. ivreghdfe lns_minus_lno (`var_fare' = `Z_core') `X_exog', ///
>     absorb(`FE') first savefirst savefp(fsiv_)  vce(robust) // vce(cluster `CL')
(MWFE estimator converged in 1 iterations)

Stored estimation results
-------------------------
-----------------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+---------------------------------------------------------------------
fsiv_avera~e | ivreg2    average_fare       7  First-stage regression: average_fare
-----------------------------------------------------------------------------------

First-stage regressions
-----------------------


First-stage regression of average_fare:

Statistics robust to heteroskedasticity
Number of obs =                1636916
------------------------------------------------------------------------------------------------
                               |               Robust
                  average_fare | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------------------------+----------------------------------------------------------------
        average_distance_rival |   .0346675   .0008007    43.30   0.000     .0330982    .0362367
average_num_destinations_rival |  -1.055499   .0087072  -121.22   0.000    -1.072565   -1.038433
                rival_carriers |  -5.666353    .066857   -84.75   0.000    -5.797391   -5.535316
                 share_nonstop |  -4.949848    .303995   -16.28   0.000    -5.545668   -4.354029
                        dist_k |   46.29696   1.845812    25.08   0.000     42.67923    49.91468
                       dist_k2 |   4.354482   .4784367     9.10   0.000     3.416762    5.292201
                   lnum_fringe |   3.634389   .2198332    16.53   0.000     3.203524    4.065254
------------------------------------------------------------------------------------------------
F test of excluded instruments:
  F(  3,1629066) =  6498.80
  Prob > F      =   0.0000
Sanderson-Windmeijer multivariate F test of excluded instruments:
  F(  3,1629066) =  6498.80
  Prob > F      =   0.0000



Summary results for first-stage regressions
-------------------------------------------

                                           (Underid)            (Weak id)
Variable     | F(  3,1629066)  P-val| SW Chi-sq(  3) P-val | SW F(  3,1629066)
average_fare |    6498.80    0.0000 |    19590.35   0.0000 |     6498.80

NB: first-stage test statistics heteroskedasticity-robust

Stock-Yogo weak ID F test critical values for single endogenous regressor:
                                    5% maximal IV relative bias    13.91
                                   10% maximal IV relative bias     9.08
                                   20% maximal IV relative bias     6.46
                                   30% maximal IV relative bias     5.39
                                   10% maximal IV size             22.30
                                   15% maximal IV size             12.83
                                   20% maximal IV size              9.54
                                   25% maximal IV size              7.80
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for i.i.d. errors only.

Underidentification test
Ho: matrix of reduced form coefficients has rank=K1-1 (underidentified)
Ha: matrix has rank=K1 (identified)
Kleibergen-Paap rk LM statistic          Chi-sq(3)=19058.39 P-val=0.0000

Weak identification test
Ho: equation is weakly identified
Cragg-Donald Wald F statistic                                    7179.44
Kleibergen-Paap Wald rk F statistic                              6498.80

Stock-Yogo weak ID test critical values for K1=1 and L1=3:
                                    5% maximal IV relative bias    13.91
                                   10% maximal IV relative bias     9.08
                                   20% maximal IV relative bias     6.46
                                   30% maximal IV relative bias     5.39
                                   10% maximal IV size             22.30
                                   15% maximal IV size             12.83
                                   20% maximal IV size              9.54
                                   25% maximal IV size              7.80
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.

Weak-instrument-robust inference
Tests of joint significance of endogenous regressors B1 in main equation
Ho: B1=0 and orthogonality conditions are valid
Anderson-Rubin Wald test           F(3,1629066)=17766.58    P-val=0.0000
Anderson-Rubin Wald test           Chi-sq(3)=   53556.57    P-val=0.0000
Stock-Wright LM S statistic        Chi-sq(3)=   50560.76    P-val=0.0000

NB: Underidentification, weak identification and weak-identification-robust
    test statistics heteroskedasticity-robust

Number of observations               N  =    1636916
Number of regressors                 K  =          5
Number of endogenous regressors      K1 =          1
Number of instruments                L  =          7
Number of excluded instruments       L1 =          3

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity

                                                      Number of obs =  1636916
                                                      F(  5,1629068) = 62517.87
                                                      Prob > F      =   0.0000
Total (centered) SS     =  5064054.029                Centered R2   =  -0.7143
Total (uncentered) SS   =  5064054.029                Uncentered R2 =  -0.7143
Residual SS             =  8681079.237                Root MSE      =    2.308

-------------------------------------------------------------------------------
              |               Robust
lns_minus_lno | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
 average_fare |   .0239113   .0002239   106.78   0.000     .0234724    .0243502
share_nonstop |   2.107872   .0086945   242.44   0.000     2.090831    2.124913
       dist_k |  -5.077151   .0435418  -116.60   0.000    -5.162491   -4.991811
      dist_k2 |   .1453129   .0108903    13.34   0.000     .1239683    .1666576
  lnum_fringe |  -.4661273   .0059956   -77.74   0.000    -.4778785   -.4543761
-------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):            1.9e+04
                                                   Chi-sq(3) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             7179.444
                         (Kleibergen-Paap rk Wald F statistic):       6498.799
Stock-Yogo weak ID test critical values:  5% maximal IV relative bias    13.91
                                         10% maximal IV relative bias     9.08
                                         20% maximal IV relative bias     6.46
                                         30% maximal IV relative bias     5.39
                                         10% maximal IV size             22.30
                                         15% maximal IV size             12.83
                                         20% maximal IV size              9.54
                                         25% maximal IV size              7.80
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):      5259.141
                                                   Chi-sq(2) P-val =    0.0000
------------------------------------------------------------------------------
Instrumented:         average_fare
Included instruments: share_nonstop dist_k dist_k2 lnum_fringe
Excluded instruments: average_distance_rival average_num_destinations_rival
                      rival_carriers
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
      market |      7843           0        7843     |
-----------------------------------------------------+

. 
. * Store F-statistic from first stage
. scalar F_stat_IV = e(widstat)

. di as yellow "First-stage F-statistic (IV): " F_stat_IV
First-stage F-statistic (IV): 6498.7994

. 
. estimates store IV

. 
. *-------------------------*
. * NESTED-LOGIT (no IV)   *
. *   ln(s_jt) - ln(s_gjt) = α p_jt + x_jt β + σ ln(s_jt|g) + FE + error
. *   No endogeneity correction - treats price and within-group share as exogenous
. *-------------------------*
. di as yellow "    ---------  Running Nested-logit (no IV) ---------"
    ---------  Running Nested-logit (no IV) ---------

. 
. reghdfe lns_minus_lno `var_fare' `X_exog' `var_nest', ///
>     absorb(`FE') vce(robust)
(MWFE estimator converged in 1 iterations)

HDFE Linear regression                            Number of obs   =  1,636,916
Absorbing 1 HDFE group                            F(   6,1629067) =   1.38e+07
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.9831
                                                  Adj R-squared   =     0.9830
                                                  Within R-sq.    =     0.9811
                                                  Root MSE        =     0.2425

-------------------------------------------------------------------------------
              |               Robust
lns_minus_lno | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
 average_fare |  -.0004863   3.91e-06  -124.50   0.000    -.0004939   -.0004786
share_nonstop |   .1188749   .0008529   139.38   0.000     .1172034    .1205465
       dist_k |  -.0469124   .0024149   -19.43   0.000    -.0516455   -.0421793
      dist_k2 |   .0043188   .0005275     8.19   0.000     .0032848    .0053527
  lnum_fringe |   .0243305   .0005482    44.39   0.000     .0232561    .0254048
lns_minus_lng |   .9775556   .0001523  6416.79   0.000      .977257    .9778542
        _cons |  -5.248843   .0023438 -2239.48   0.000    -5.253437    -5.24425
-------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
      market |      7843           0        7843     |
-----------------------------------------------------+

. 
. estimates store NL_OLS

. 
. *-------------------------*
. * IV NESTED-LOGIT        *
. *   ln(s_jt) - ln(s_gjt) = α p_jt + x_jt β + σ ln(s_jt|g) + FE + error
. *   Endogenous: p_jt and ln(s_jt|g). Instruments: Z_core plus functions of rivalry.
. *   We also include the exogenous X's as their own instruments by default.
. *-------------------------*
. di as yellow "    ---------  Running IV nested-logit (price and ln(s_jt|g) endogenous) ---------"
    ---------  Running IV nested-logit (price and ln(s_jt|g) endogenous) ---------

. 
. ivreghdfe lns_minus_lno (`var_nest' `var_fare' = `Z_core') `X_exog', ///
>     absorb(`FE')  first savefirst savefp(fsivn_)  vce(robust)
(MWFE estimator converged in 1 iterations)

Stored estimation results
-------------------------
------------------------------------------------------------------------------------
             |           Dependent  Number of        
        Name | Command    variable     param.  Title 
-------------+----------------------------------------------------------------------
fsivn_lns_~g | ivreg2    lns_minus_~g       7  First-stage regression: lns_minus_lng
fsivn_aver~e | ivreg2    average_fare       7  First-stage regression: average_fare
------------------------------------------------------------------------------------

First-stage regressions
-----------------------


First-stage regression of lns_minus_lng:

Statistics robust to heteroskedasticity
Number of obs =                1636916
------------------------------------------------------------------------------------------------
                               |               Robust
                 lns_minus_lng | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------------------------+----------------------------------------------------------------
        average_distance_rival |   .0016182   .0000124   130.28   0.000     .0015939    .0016426
average_num_destinations_rival |  -.0192944   .0001545  -124.90   0.000    -.0195972   -.0189917
                rival_carriers |  -.2889205   .0011123  -259.76   0.000    -.2911005   -.2867405
                 share_nonstop |    1.88614   .0045067   418.51   0.000     1.877307    1.894973
                        dist_k |  -3.835727   .0121757  -315.03   0.000    -3.859591   -3.811864
                       dist_k2 |   .2392889   .0027418    87.28   0.000     .2339152    .2446627
                   lnum_fringe |  -.0479505   .0038447   -12.47   0.000     -.055486   -.0404151
------------------------------------------------------------------------------------------------
F test of excluded instruments:
  F(  3,1629066) = 26131.59
  Prob > F      =   0.0000
Sanderson-Windmeijer multivariate F test of excluded instruments:
  F(  2,1629066) =  2667.64
  Prob > F      =   0.0000


First-stage regression of average_fare:

Statistics robust to heteroskedasticity
Number of obs =                1636916
------------------------------------------------------------------------------------------------
                               |               Robust
                  average_fare | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------------------------+----------------------------------------------------------------
        average_distance_rival |   .0346675   .0008007    43.30   0.000     .0330982    .0362367
average_num_destinations_rival |  -1.055499   .0087072  -121.22   0.000    -1.072565   -1.038433
                rival_carriers |  -5.666353    .066857   -84.75   0.000    -5.797391   -5.535316
                 share_nonstop |  -4.949848    .303995   -16.28   0.000    -5.545668   -4.354029
                        dist_k |   46.29696   1.845812    25.08   0.000     42.67923    49.91468
                       dist_k2 |   4.354482   .4784367     9.10   0.000     3.416762    5.292201
                   lnum_fringe |   3.634389   .2198332    16.53   0.000     3.203524    4.065254
------------------------------------------------------------------------------------------------
F test of excluded instruments:
  F(  3,1629066) =  6498.80
  Prob > F      =   0.0000
Sanderson-Windmeijer multivariate F test of excluded instruments:
  F(  2,1629066) =  2464.45
  Prob > F      =   0.0000



Summary results for first-stage regressions
-------------------------------------------

                                           (Underid)            (Weak id)
Variable     | F(  3,1629066)  P-val| SW Chi-sq(  2) P-val | SW F(  2,1629066)
lns_minus_ln |   26131.59    0.0000 |     5360.99   0.0000 |     2667.64
average_fare |    6498.80    0.0000 |     4952.65   0.0000 |     2464.45

NB: first-stage test statistics heteroskedasticity-robust

Stock-Yogo weak ID F test critical values for single endogenous regressor:
                                    5% maximal IV relative bias    13.91
                                   10% maximal IV relative bias     9.08
                                   20% maximal IV relative bias     6.46
                                   30% maximal IV relative bias     5.39
                                   10% maximal IV size             22.30
                                   15% maximal IV size             12.83
                                   20% maximal IV size              9.54
                                   25% maximal IV size              7.80
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for i.i.d. errors only.

Underidentification test
Ho: matrix of reduced form coefficients has rank=K1-1 (underidentified)
Ha: matrix has rank=K1 (identified)
Kleibergen-Paap rk LM statistic          Chi-sq(2)=4677.15  P-val=0.0000

Weak identification test
Ho: equation is weakly identified
Cragg-Donald Wald F statistic                                    1696.17
Kleibergen-Paap Wald rk F statistic                              1575.41

Stock-Yogo weak ID test critical values for K1=2 and L1=3:
                                   10% maximal IV size             13.43
                                   15% maximal IV size              8.18
                                   20% maximal IV size              6.40
                                   25% maximal IV size              5.45
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.

Weak-instrument-robust inference
Tests of joint significance of endogenous regressors B1 in main equation
Ho: B1=0 and orthogonality conditions are valid
Anderson-Rubin Wald test           F(3,1629066)=17766.58    P-val=0.0000
Anderson-Rubin Wald test           Chi-sq(3)=   53556.57    P-val=0.0000
Stock-Wright LM S statistic        Chi-sq(3)=   50560.76    P-val=0.0000

NB: Underidentification, weak identification and weak-identification-robust
    test statistics heteroskedasticity-robust

Number of observations               N  =    1636916
Number of regressors                 K  =          6
Number of endogenous regressors      K1 =          2
Number of instruments                L  =          7
Number of excluded instruments       L1 =          3

IV (2SLS) estimation
--------------------

Estimates efficient for homoskedasticity only
Statistics robust to heteroskedasticity

                                                      Number of obs =  1636916
                                                      F(  6,1629067) =  3.7e+06
                                                      Prob > F      =   0.0000
Total (centered) SS     =  5064054.029                Centered R2   =   0.9720
Total (uncentered) SS   =  5064054.029                Uncentered R2 =   0.9720
Residual SS             =  141661.3992                Root MSE      =    .2949

-------------------------------------------------------------------------------
              |               Robust
lns_minus_lno | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
lns_minus_lng |   .8739886   .0014492   603.07   0.000     .8711481     .876829
 average_fare |  -.0019322   .0000523   -36.95   0.000    -.0020346   -.0018297
share_nonstop |   .3048378   .0032073    95.04   0.000     .2985515    .3111241
       dist_k |  -.4330385   .0091243   -47.46   0.000    -.4509218   -.4151553
      dist_k2 |   .0398465   .0012218    32.61   0.000     .0374518    .0422412
  lnum_fringe |  -.0334629   .0009859   -33.94   0.000    -.0353952   -.0315306
-------------------------------------------------------------------------------
Underidentification test (Kleibergen-Paap rk LM statistic):           4677.152
                                                   Chi-sq(2) P-val =    0.0000
------------------------------------------------------------------------------
Weak identification test (Cragg-Donald Wald F statistic):             1696.171
                         (Kleibergen-Paap rk Wald F statistic):       1575.411
Stock-Yogo weak ID test critical values: 10% maximal IV size             13.43
                                         15% maximal IV size              8.18
                                         20% maximal IV size              6.40
                                         25% maximal IV size              5.45
Source: Stock-Yogo (2005).  Reproduced by permission.
NB: Critical values are for Cragg-Donald F statistic and i.i.d. errors.
------------------------------------------------------------------------------
Hansen J statistic (overidentification test of all instruments):       950.347
                                                   Chi-sq(1) P-val =    0.0000
------------------------------------------------------------------------------
Instrumented:         lns_minus_lng average_fare
Included instruments: share_nonstop dist_k dist_k2 lnum_fringe
Excluded instruments: average_distance_rival average_num_destinations_rival
                      rival_carriers
Partialled-out:       _cons
                      nb: total SS, model F and R2s are after partialling-out;
                          any small-sample adjustments include partialled-out
                          variables in regressor count K
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
      market |      7843           0        7843     |
-----------------------------------------------------+

. 
. * Store F-statistic from first stage
. scalar F_stat_IV_NL = e(widstat)

. di as yellow "First-stage F-statistic (IV Nested-Logit): " F_stat_IV_NL
First-stage F-statistic (IV Nested-Logit): 1575.411

. 
. estimates store IV_NL

. 
. 
. *-------------------------*
. * COLLECT & EXPORT TABLE *
. *-------------------------*
. 
. // export also first stage results for IV nested-logit
. 
. esttab  fsivn_`var_fare' using "$OUT/demand_results_fs_fare.tex", replace ///
>     b(4) se(4) label booktabs se star(* 0.10 ** 0.05 *** 0.01)
(output written to ./src/output//demand_results_fs_fare.tex)

. 
. esttab fsivn_`var_nest' using "$OUT/demand_results_fs_nest.tex", replace ///
>     b(4) se(4) label booktabs se star(* 0.10 ** 0.05 *** 0.01)
(output written to ./src/output//demand_results_fs_nest.tex)

. 
. cap which esttab

. esttab OLS IV NL_OLS IV_NL using "$OUT/demand_results.tex", replace ///
>     b(4) se(4) ar2  label booktabs se star(* 0.10 ** 0.05 *** 0.01) ///
>     keep(`var_fare' share_nonstop dist_k dist_k2 lnum_fringe `var_nest') ///
>     order(`var_fare' share_nonstop dist_k dist_k2 lnum_fringe `var_nest') ///
>     scalars("N Observations" "widstat F-statistic (IV)") ///
>     title("Demand Estimates (Logit and Nested-Logit)") nonotes
(output written to ./src/output//demand_results.tex)

.         // stats(N r2, fmt(0 3) labels("Observations" "R^2")) ///
. 
. display as text "Saved: $OUT/demand_results.tex"
Saved: ./src/output//demand_results.tex

. 
. *-------------------------*
. * ELASTICITIES 
. *   Own-price elasticity for logit: ε_j = α * p_jt * (1 - s_jt)
. *   For nested-logit, adjust by 1 - σ*(1 - s_gjt)
. *-------------------------*
. di as yellow "    ---------  Calculating elasticities ---------"
    ---------  Calculating elasticities ---------

. tempvar elast_logit elast_nlogit

. scalar alpha = _b[`var_fare']  // from last model in memory; switch if needed

. 
. * Using OLS as quick check:
. est restore OLS
(results OLS are active now)

. scalar alpha_ols = _b[`var_fare']

. 
. gen `elast_logit'  = alpha_ols * `var_fare' * (1 - s_jt)

. 
. * Using nested-logit IV estimate:
. est restore IV_NL
(results IV_NL are active now)

. scalar alpha_nl = _b[`var_fare']

. scalar sigma    = _b[`var_nest']

. 
. gen `elast_nlogit' = alpha_nl * `var_fare' * (1 - s_jt) / (1 - sigma*(1 - s_gjt))

. 
. sum `elast_logit' `elast_nlogit'

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    __000000 |  1,636,916   -.3860752    .1598623  -4.282915  -.0429605
    __000001 |  1,636,916   -3.292133    1.384941   -36.0312  -.0916681

. 
. // Export elasticities
. qui estpost sum `elast_logit' `elast_nlogit', detail

. esttab using "$OUT/demand_elasticities.tex", replace ///
>     title("Elasticities: Own-price (Logit and Nested-Logit)") ///
>     cells("count mean(fmt(3)) sd(fmt(3)) min(fmt(3)) p25(fmt(3)) p50(fmt(3)) p75(fmt(3)) max(fmt(3))") ///
>     label booktabs nonum ///
>     varlabels(`elast_logit' "Logit Elasticity" `elast_nlogit' "Nested-Logit Elasticity")
(output written to ./src/output//demand_elasticities.tex)

. 
. display as text "Saved: $OUT/demand_elasticities.tex"
Saved: ./src/output//demand_elasticities.tex

. // export histogram of elasticities
. preserve

. 
.     keep if `elast_nlogit' < 1 & `elast_nlogit' > -10 // filter for better histogram
(5,546 observations deleted)

.     histogram `elast_nlogit', ///
>         title("Own-Price Elasticities (Nested-Logit)") ///
>         xtitle("Elasticity") ytitle("Frequency") ///
>         graphregion(color(white)) plotregion(color(white)) ///
>         bin(100) fcolor(navy%60) lcolor(white) lwidth(thin) ///
>         xscale(range(-10 1)) xlabel(-10(2)1)
(bin=100, start=-9.9999418, width=.09908274)

. 
.     // # use graph export
.     graph export "$OUT/elasticity_logit_histogram.pdf", replace
file /Users/gisellelab/Work/airlines_merger_simulation/src/output//elasticity_logit_histogram.pdf saved as PDF format

. 
. display as text "Saved: $OUT/elasticity_logit_histogram.pdf"
Saved: ./src/output//elasticity_logit_histogram.pdf

. 
. 
. log close
      name:  <unnamed>
       log:  /Users/gisellelab/Work/airlines_merger_simulation/src/logs/demand_estimation.log
  log type:  text
 closed on:  19 Aug 2025, 19:07:31
-------------------------------------------------------------------------------------------------------------------------
